# 端到端全栈博客 & 资源管理示例项目

本示例提供：前端博客页面 + 后端 API (FastAPI) + Markdown 内容管理 + 图片离线优化 +（可选）数据采集脚本。  
目标：快速搭建一个可扩展的个人知识博客基础骨架，可逐步演进为完整内容平台。

---
## 目录结构总览

```text
project-root/
├─ README.md
├─ build.sh
├─ requirements.txt
├─ backend/
│  ├─ app.py
│  ├─ db.py
│  ├─ models.sql
│  ├─ settings.py
│  └─ utils_markdown.py
├─ content/
│  └─ posts/
│     ├─ 2025-08-01-design-principles.md
│     ├─ 2025-07-26-fe-performance.md
│     └─ ... (更多 Markdown)
├─ data/
│  ├─ posts_cache.json          # 构建时产出
│  └─ images/ (可选：存放生成的 optimized 图)
├─ frontend/
│  ├─ index.html
│  ├─ post.html
│  ├─ assets/
│  │  ├─ css/
│  │  │  └─ style.css
│  │  ├─ js/
│  │  │  ├─ app.js
│  │  │  ├─ api.js
│  │  │  └─ render.js
│  │  └─ img/ (静态图片/占位符)
└─ scripts/
   ├─ import_markdown.py
   ├─ image_manager.py          # 图片优化脚本（之前提供，可直接放入）
   └─ scraper.py                # 数据采集脚本（之前提供，可直接放入）
```

---
## 一、后端部分 (FastAPI + SQLite)

### backend/settings.py
```python
import os
BASE_DIR = os.path.dirname(os.path.dirname(__file__))
CONTENT_DIR = os.path.join(BASE_DIR, "content", "posts")
DATA_DIR = os.path.join(BASE_DIR, "data")
DB_PATH = os.path.join(DATA_DIR, "blog.db")
POSTS_JSON = os.path.join(DATA_DIR, "posts_cache.json")
PAGE_SIZE_DEFAULT = 10
ALLOWED_IMAGE_DIR = os.path.join(DATA_DIR, "images")
os.makedirs(DATA_DIR, exist_ok=True)
os.makedirs(ALLOWED_IMAGE_DIR, exist_ok=True)
```

### backend/models.sql
```sql
-- 基础文章表
CREATE TABLE IF NOT EXISTS posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  slug TEXT UNIQUE,
  title TEXT,
  date TEXT,
  tags TEXT,
  excerpt TEXT,
  content_html TEXT,
  raw_md TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_posts_date ON posts(date DESC);
CREATE INDEX IF NOT EXISTS idx_posts_tags ON posts(tags);
```

### backend/db.py
```python
import sqlite3, json, time
from contextlib import contextmanager
from pathlib import Path
from . import settings

def get_conn():
    return sqlite3.connect(settings.DB_PATH)

def init_db():
    conn = get_conn()
    sql = (Path(__file__).parent / "models.sql").read_text("utf-8")
    conn.executescript(sql)
    conn.commit()
    conn.close()

@contextmanager
def db():
    conn = get_conn()
    try:
        yield conn
    finally:
        conn.close()

def upsert_post(p):
    with db() as conn:
        conn.execute("""
        INSERT INTO posts (slug,title,date,tags,excerpt,content_html,raw_md,updated_at)
        VALUES (?,?,?,?,?,?,?,CURRENT_TIMESTAMP)
        ON CONFLICT(slug) DO UPDATE SET
          title=excluded.title,
          date=excluded.date,
          tags=excluded.tags,
          excerpt=excluded.excerpt,
          content_html=excluded.content_html,
          raw_md=excluded.raw_md,
          updated_at=CURRENT_TIMESTAMP
        """, (
            p["slug"], p["title"], p["date"], ",".join(p["tags"]),
            p["excerpt"], p["content_html"], p["raw_md"]
        ))
        conn.commit()

def query_posts(page=1, page_size=10, tag=None, keyword=None):
    where = []
    params = []
    if tag:
        where.append("tags LIKE ?")
        params.append(f"%{tag}%")
    if keyword:
        where.append("(title LIKE ? OR excerpt LIKE ? OR content_html LIKE ?)")
        params.extend([f"%{keyword}%", f"%{keyword}%", f"%{keyword}%"])
    base = "SELECT slug,title,date,tags,excerpt FROM posts"
    if where:
        base += " WHERE " + " AND ".join(where)
    base += " ORDER BY date DESC, id DESC LIMIT ? OFFSET ?"
    params.extend([page_size, (page-1)*page_size])
    with db() as conn:
        rows = conn.execute(base, params).fetchall()
        total = conn.execute("SELECT COUNT(*) FROM posts" + (" WHERE "+ " AND ".join(where) if where else ""), params[:-2]).fetchone()[0]
    posts = []
    for r in rows:
        posts.append({
            "slug": r[0],
            "title": r[1],
            "date": r[2],
            "tags": r[3].split(",") if r[3] else [],
            "excerpt": r[4]
        })
    return posts, total

def get_post(slug):
    with db() as conn:
        r = conn.execute("""
        SELECT slug,title,date,tags,excerpt,content_html,raw_md
        FROM posts WHERE slug=?
        """, (slug,)).fetchone()
    if not r:
        return None
    return {
        "slug": r[0],
        "title": r[1],
        "date": r[2],
        "tags": r[3].split(",") if r[3] else [],
        "excerpt": r[4],
        "content_html": r[5],
        "raw_md": r[6]
    }

def all_tags():
    with db() as conn:
        rows = conn.execute("SELECT tags FROM posts").fetchall()
    freq = {}
    for (tstr,) in rows:
        if not tstr: continue
        for t in tstr.split(","):
            freq[t] = freq.get(t,0)+1
    return [{"tag":k,"count":v} for k,v in sorted(freq.items(), key=lambda x:-x[1])]
```

### backend/utils_markdown.py
```python
import re, markdown

MD_EXTS = ["fenced_code", "codehilite", "tables", "toc", "abbr", "def_list"]

def md_to_html(md_text: str):
    html = markdown.markdown(md_text, extensions=MD_EXTS)
    return sanitize(html)

def sanitize(html: str):
    # 简化：示意过滤 <script>; 如需更严格可用 bleach
    return re.sub(r"<script.*?>.*?</script>", "", html, flags=re.I|re.S)
```

### backend/app.py
```python
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
from . import db, settings

db.init_db()
app = FastAPI(title="Blog API", version="0.1.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

class PostIn(BaseModel):
    title: str
    date: str
    tags: list[str] = []
    excerpt: str
    content_html: str
    raw_md: str
    slug: str

@app.get("/api/health")
def health():
    return {"ok": True}

@app.get("/api/posts")
def list_posts(
        page: int = Query(1, ge=1),
        page_size: int = Query(settings.PAGE_SIZE_DEFAULT, ge=1, le=50),
        tag: str | None = None,
        keyword: str | None = None
    ):
    items, total = db.query_posts(page=page, page_size=page_size, tag=tag, keyword=keyword)
    return {"list": items, "page": page, "page_size": page_size, "total": total}

@app.get("/api/posts/{slug}")
def get_post(slug: str):
    p = db.get_post(slug)
    if not p:
        raise HTTPException(404, "Post not found")
    return p

@app.get("/api/tags")
def list_tags():
    return db.all_tags()

# 简单图片列表（如果已跑过 image_manager 输出到 data/images/optimized）
import os, glob
@app.get("/api/images")
def list_images():
    root = settings.ALLOWED_IMAGE_DIR
    out = []
    for p in glob.glob(os.path.join(root, "optimized", "**", "*.jpg"), recursive=True):
        rel = p.replace(root + os.sep, "")
        out.append({"path": rel})
    return out

# 动态写入（后台构建后提交）
@app.post("/api/posts")
def create_or_update(post: PostIn):
    db.upsert_post(post.dict())
    return {"ok": True}
```

---
## 二、Markdown 导入脚本

### scripts/import_markdown.py
```python
"""
读取 content/posts/*.md -> 解析 FrontMatter -> 转 HTML -> 写入 SQLite & posts_cache.json
"""
import os, re, json, yaml
from pathlib import Path
import sys
sys.path.append(str(Path(__file__).resolve().parents[1] / "backend"))
from utils_markdown import md_to_html
import db, settings

FRONT_RE = re.compile(r"^---\\s*\\n(.*?)\\n---\\s*\\n(.*)$", re.S)

def slugify(s: str):
    return re.sub(r"[^a-z0-9-]+", "-", s.lower()).strip("-")

def parse_file(path: Path):
    raw = path.read_text("utf-8")
    m = FRONT_RE.match(raw)
    if not m:
        raise ValueError(f"缺少 FrontMatter: {path}")
    front_raw, body = m.group(1), m.group(2)
    meta = yaml.safe_load(front_raw) or {}
    title = meta.get("title") or path.stem
    date = str(meta.get("date"))
    tags = meta.get("tags") or []
    excerpt = meta.get("excerpt") or body.strip().split("\\n")[0][:160]
    html = md_to_html(body)
    slug = meta.get("slug") or f"{date}-{slugify(title)}"
    return {
        "title": title,
        "date": date,
        "tags": tags,
        "excerpt": excerpt,
        "content_html": html,
        "raw_md": body,
        "slug": slug
    }

def main():
    posts_dir = Path(settings.CONTENT_DIR)
    out_json = Path(settings.POSTS_JSON)
    posts = []
    for md_file in sorted(posts_dir.glob("*.md")):
        p = parse_file(md_file)
        db.upsert_post(p)
        posts.append(p)
        print("导入:", p["slug"])
    out_json.write_text(json.dumps(posts, ensure_ascii=False, indent=2), "utf-8")
    print("写出缓存:", out_json)

if __name__ == "__main__":
    main()
```

---
## 三、示例 Markdown 内容

### content/posts/2025-08-01-design-principles.md
```markdown
---
title: 打造个人知识库的 7 个关键设计原则
date: 2025-08-01
tags: [知识管理, 效率, PKM]
excerpt: 个人知识库不仅是笔记堆积，而是一个系统。本文总结 7 个核心设计原则。
slug: 2025-08-01-design-principles
---

## 1 原子化
保持粒度小...

## 2 语义化命名
...
```

### content/posts/2025-07-26-fe-performance.md
```markdown
---
title: 前端性能优化：直击 9 个高影响指标
date: 2025-07-26
tags: [前端, 性能, Web]
excerpt: 聚焦 9 个最能提升体验的关键指标。
slug: 2025-07-26-fe-performance
---

## 核心指标
FCP / LCP / CLS / INP / TTFB ...
```

---
## 四、前端文件

### frontend/index.html
（精简版，调用后端 API；可替换为之前提供的高级模板）
```html
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <title>我的博客</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
  <header class="site-header">
    <h1>我的博客</h1>
    <nav>
      <a href="index.html" class="active">首页</a>
      <a href="tags.html">标签</a>
    </nav>
    <input id="searchInput" placeholder="搜索..."/>
  </header>
  <main id="app">
    <div id="posts" class="post-list"></div>
    <div id="pagination"></div>
  </main>
  <footer>© <span id="year"></span> MyBlog</footer>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/render.js"></script>
  <script src="assets/js/app.js"></script>
</body>
</html>
```

### frontend/post.html
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title id="pageTitle">加载中...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
  <header class="site-header"><a href="index.html">← 返回</a></header>
  <article id="postContainer" class="article"></article>
  <footer>© <span id="year"></span> MyBlog</footer>
  <script src="assets/js/api.js"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    const params = new URLSearchParams(location.search);
    const slug = params.get("slug");
    if (!slug) {
      document.getElementById("postContainer").innerHTML = "缺少 slug 参数";
    } else {
      fetchAPI("/posts/" + slug).then(p=>{
        document.title = p.title;
        const el = document.getElementById("postContainer");
        el.innerHTML = `
          <h1>${p.title}</h1>
          <div class="meta">${p.date} · ${p.tags.join(" / ")}</div>
          <div class="content">${p.content_html}</div>
        `;
      }).catch(()=>{
        document.getElementById("postContainer").textContent = "文章加载失败";
      });
    }
  </script>
</body>
</html>
```

### frontend/assets/css/style.css
```css
:root {
  --bg:#fff; --fg:#1f2933; --muted:#64748b; --accent:#2563eb; --border:#e2e8f0;
}
body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto; background:var(--bg); color:var(--fg); }
.site-header { display:flex; gap:1rem; align-items:center; padding:.75rem 1rem; border-bottom:1px solid var(--border); }
nav a { text-decoration:none; color:var(--muted); padding:.35rem .6rem; border-radius:4px; font-size:.85rem; }
nav a.active, nav a:hover { background:#f1f5f9; color:var(--fg); }
input#searchInput { margin-left:auto; padding:.45rem .6rem; border:1px solid var(--border); border-radius:4px; }
footer { text-align:center; padding:2rem 1rem; font-size:.7rem; color:var(--muted); }
.post-list { max-width:920px; margin:1.2rem auto; display:grid; gap:1rem; padding:0 1rem; }
.card { border:1px solid var(--border); border-radius:10px; padding:1rem 1.1rem; background:#f8fafc; transition:.25s; }
.card:hover { border-color:var(--accent); transform:translateY(-2px); }
.card h2 { margin:.2rem 0 .6rem; font-size:1.1rem; }
.tags { display:flex; flex-wrap:wrap; gap:.4rem; }
.tag { font-size:.55rem; text-transform:uppercase; background:#fff; border:1px solid var(--border); padding:.25rem .45rem; border-radius:4px; letter-spacing:.5px; }
.pagination { display:flex; justify-content:center; gap:.4rem; flex-wrap:wrap; margin:1.5rem 0 3rem; }
.pagination button { border:1px solid var(--border); background